rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid}/topics/{topicId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update: if request.auth != null && request.auth.uid == uid
        && isValid(request.resource.data);
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    match /users/{uid}/favorites/{favId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update: if request.auth != null && request.auth.uid == uid
        && isFavoriteValid(request.resource.data);
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    match /users/{uid}/prefs/{prefId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update: if request.auth != null && request.auth.uid == uid
        && isPrefsValid(request.resource.data);
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    match /users/{uid}/srs/{cardId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update: if request.auth != null && request.auth.uid == uid
        && isSrsValid(request.resource.data);
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    match /users/{uid}/highlights/{highlightId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update: if request.auth != null && request.auth.uid == uid
        && isHighlightValid(request.resource.data);
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    function isValid(data) {
      return (data.favorite is bool || !('favorite' in data))
        && (data.readLevel is int || !('readLevel' in data))
        && (!('readLevel' in data) || (data.readLevel >= 0 && data.readLevel <= 5));
    }

    function isFavoriteValid(data) {
      return (data.type is string || !('type' in data))
        && (data.itemId is string || !('itemId' in data))
        && (data.favorite is bool || !('favorite' in data));
    }

    function isPrefsValid(data) {
      return data.keys().hasOnly(['theme', 'topicsListLayout', 'topicsSortMode', 'updatedAt'])
        && (!('theme' in data) || (data.theme is string && (data.theme == 'light' || data.theme == 'dark')))
        && (!('topicsListLayout' in data) || (data.topicsListLayout is string && (data.topicsListLayout == 'cards' || data.topicsListLayout == 'compact')))
        && (!('topicsSortMode' in data) || (data.topicsSortMode is string && (
          data.topicsSortMode == 'added' ||
          data.topicsSortMode == 'topic' ||
          data.topicsSortMode == 'category' ||
          data.topicsSortMode == 'priority' ||
          data.topicsSortMode == 'needsReview' ||
          data.topicsSortMode == 'mostReviewed'
        )))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isSrsValid(data) {
      return data.keys().hasOnly(['showCount', 'correctCount', 'totalReviews', 'nextShowIn', 'difficultyLevel', 'status', 'updatedAt', 'v'])
        && (!('showCount' in data) || (data.showCount is int && data.showCount >= 0))
        && (!('correctCount' in data) || (data.correctCount is int && data.correctCount >= 0))
        && (!('totalReviews' in data) || (data.totalReviews is int && data.totalReviews >= 0))
        && (!('nextShowIn' in data) || (data.nextShowIn is int && data.nextShowIn >= 0))
        && (!('difficultyLevel' in data) || ((data.difficultyLevel is int || data.difficultyLevel is float) && data.difficultyLevel >= 1 && data.difficultyLevel <= 5))
        && (!('status' in data) || (data.status is string && (data.status == 'new' || data.status == 'learning' || data.status == 'mastered')))
        && (!('v' in data) || (data.v is int && data.v >= 1 && data.v <= 10))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isHighlightValid(data) {
      return data.keys().hasOnly(['topicId', 'start', 'end', 'quote', 'prefix', 'suffix', 'color', 'updatedAt'])
        && ('topicId' in data) && (data.topicId is string) && (data.topicId.size() > 0) && (data.topicId.size() <= 64)
        && ('start' in data) && (data.start is int) && (data.start >= 0)
        && ('end' in data) && (data.end is int) && (data.end > data.start) && ((data.end - data.start) <= 20000)
        && ('quote' in data) && (data.quote is string) && (data.quote.size() > 0) && (data.quote.size() <= 1600)
        && ('prefix' in data) && (data.prefix is string) && (data.prefix.size() <= 36)
        && ('suffix' in data) && (data.suffix is string) && (data.suffix.size() <= 36)
        && ('color' in data) && (data.color is string) && (data.color.matches('^#([0-9a-fA-F]{6})$'))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }
  }
}
