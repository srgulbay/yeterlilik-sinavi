rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isAdmin() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isBootstrapAdminEmail() {
      return isSignedIn()
        && request.auth.token.email == 'srgulbay@gmail.com'
        && request.auth.token.email_verified == true;
    }

    match /users/{uid}/topics/{topicId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && isTopicStateValid(request.resource.data);
      allow delete: if isOwner(uid);
    }

    match /users/{uid}/favorites/{favId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && isFavoriteValid(request.resource.data);
      allow delete: if isOwner(uid);
    }

    match /users/{uid}/prefs/{prefId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && isPrefsValid(request.resource.data);
      allow delete: if isOwner(uid);
    }

    match /users/{uid}/srs/{cardId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && isSrsValid(request.resource.data);
      allow delete: if isOwner(uid);
    }

    match /users/{uid}/highlights/{highlightId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && isHighlightValid(request.resource.data);
      allow delete: if isOwner(uid);
    }

    match /users/{uid}/inbox/{notificationId} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isAdmin() && isInboxValid(request.resource.data);
      allow update: if isOwner(uid)
        && isInboxValid(request.resource.data)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readAt']);
      allow delete: if isOwner(uid) || isAdmin();
    }

    match /users/{uid}/pushTokens/{tokenId} {
      allow read: if isOwner(uid) || isAdmin();
      allow create, update: if isOwner(uid) && isPushTokenValid(request.resource.data);
      allow delete: if isOwner(uid) || isAdmin();
    }

    match /admins/{adminUid} {
      allow read: if isOwner(adminUid) || isAdmin();
      allow create: if (isAdmin() && isAdminDocValid(request.resource.data))
        || (isOwner(adminUid) && isBootstrapAdminEmail());
      allow update: if isAdmin() && isAdminDocValid(request.resource.data);
      allow delete: if isAdmin();
    }

    match /userProfiles/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create, update: if isOwner(uid) && isUserProfileValid(uid, request.resource.data);
      allow delete: if isAdmin();
    }

    match /adminNotifications/{logId} {
      allow read: if isAdmin();
      allow create, update: if isAdmin() && isAdminNotificationLogValid(request.resource.data);
      allow delete: if isAdmin();
    }

    function isTopicStateValid(data) {
      return (data.favorite is bool || !('favorite' in data))
        && (data.readLevel is int || !('readLevel' in data))
        && (!('readLevel' in data) || (data.readLevel >= 0 && data.readLevel <= 5))
        && (data.readingProgress is int || !('readingProgress' in data))
        && (!('readingProgress' in data) || (data.readingProgress >= 0 && data.readingProgress <= 100))
        && (data.readingSectionId is string || !('readingSectionId' in data))
        && (!('readingSectionId' in data) || (data.readingSectionId.size() <= 140))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isFavoriteValid(data) {
      return (data.type is string || !('type' in data))
        && (data.itemId is string || !('itemId' in data))
        && (data.favorite is bool || !('favorite' in data));
    }

    function isPrefsValid(data) {
      return data.keys().hasOnly(['theme', 'topicsListLayout', 'topicsSortMode', 'updatedAt'])
        && (!('theme' in data) || (data.theme is string && (data.theme == 'light' || data.theme == 'dark')))
        && (!('topicsListLayout' in data) || (data.topicsListLayout is string && (data.topicsListLayout == 'cards' || data.topicsListLayout == 'compact')))
        && (!('topicsSortMode' in data) || (data.topicsSortMode is string && (
          data.topicsSortMode == 'added' ||
          data.topicsSortMode == 'topic' ||
          data.topicsSortMode == 'category' ||
          data.topicsSortMode == 'priority' ||
          data.topicsSortMode == 'needsReview' ||
          data.topicsSortMode == 'mostReviewed'
        )))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isSrsValid(data) {
      return data.keys().hasOnly(['showCount', 'correctCount', 'totalReviews', 'nextShowIn', 'difficultyLevel', 'status', 'updatedAt', 'v'])
        && (!('showCount' in data) || (data.showCount is int && data.showCount >= 0))
        && (!('correctCount' in data) || (data.correctCount is int && data.correctCount >= 0))
        && (!('totalReviews' in data) || (data.totalReviews is int && data.totalReviews >= 0))
        && (!('nextShowIn' in data) || (data.nextShowIn is int && data.nextShowIn >= 0))
        && (!('difficultyLevel' in data) || ((data.difficultyLevel is int || data.difficultyLevel is float) && data.difficultyLevel >= 1 && data.difficultyLevel <= 5))
        && (!('status' in data) || (data.status is string && (data.status == 'new' || data.status == 'learning' || data.status == 'mastered')))
        && (!('v' in data) || (data.v is int && data.v >= 1 && data.v <= 10))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isHighlightValid(data) {
      return data.keys().hasOnly(['topicId', 'start', 'end', 'quote', 'prefix', 'suffix', 'color', 'updatedAt'])
        && ('topicId' in data) && (data.topicId is string) && (data.topicId.size() > 0) && (data.topicId.size() <= 64)
        && ('start' in data) && (data.start is int) && (data.start >= 0)
        && ('end' in data) && (data.end is int) && (data.end > data.start) && ((data.end - data.start) <= 20000)
        && ('quote' in data) && (data.quote is string) && (data.quote.size() > 0) && (data.quote.size() <= 1600)
        && ('prefix' in data) && (data.prefix is string) && (data.prefix.size() <= 36)
        && ('suffix' in data) && (data.suffix is string) && (data.suffix.size() <= 36)
        && ('color' in data) && (data.color is string) && (data.color.matches('^#([0-9a-fA-F]{6})$'))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isInboxValid(data) {
      return data.keys().hasOnly(['title', 'body', 'url', 'createdAt', 'createdBy', 'readAt'])
        && ('title' in data) && (data.title is string) && (data.title.size() > 0) && (data.title.size() <= 120)
        && (!('body' in data) || (data.body is string && data.body.size() <= 800))
        && (!('url' in data) || (data.url is string && data.url.size() <= 500))
        && (!('createdBy' in data) || (data.createdBy is string && data.createdBy.size() > 0 && data.createdBy.size() <= 128))
        && (!('createdAt' in data) || (data.createdAt is timestamp))
        && (!('readAt' in data) || (data.readAt is timestamp));
    }

    function isPushTokenValid(data) {
      return data.keys().hasOnly(['token', 'endpoint', 'p256dh', 'auth', 'userAgent', 'updatedAt', 'v'])
        && (!('token' in data) || (data.token is string && data.token.size() > 0 && data.token.size() <= 2048))
        && (!('endpoint' in data) || (data.endpoint is string && data.endpoint.size() > 0 && data.endpoint.size() <= 2048))
        && (!('p256dh' in data) || (data.p256dh is string && data.p256dh.size() > 0 && data.p256dh.size() <= 256))
        && (!('auth' in data) || (data.auth is string && data.auth.size() > 0 && data.auth.size() <= 256))
        && (!('v' in data) || (data.v is int && data.v >= 1 && data.v <= 10))
        && (!('userAgent' in data) || (data.userAgent is string && data.userAgent.size() <= 180))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isAdminDocValid(data) {
      return data.keys().hasOnly(['role', 'createdAt', 'createdBy', 'updatedAt'])
        && (!('role' in data) || (data.role is string && data.role.size() <= 32))
        && (!('createdBy' in data) || (data.createdBy is string && data.createdBy.size() > 0 && data.createdBy.size() <= 128))
        && (!('createdAt' in data) || (data.createdAt is timestamp))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isUserProfileValid(uid, data) {
      return data.keys().hasOnly(['uid', 'email', 'emailLower', 'createdAt', 'lastSeenAt', 'updatedAt'])
        && (!('uid' in data) || (data.uid is string && data.uid == uid))
        && (!('email' in data) || (data.email is string && data.email.size() <= 180))
        && (!('emailLower' in data) || (data.emailLower is string && data.emailLower.size() <= 180))
        && (!('createdAt' in data) || (data.createdAt is timestamp))
        && (!('lastSeenAt' in data) || (data.lastSeenAt is timestamp))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }

    function isAdminNotificationLogValid(data) {
      return data.keys().hasOnly(['title', 'body', 'url', 'recipientsCount', 'broadcast', 'recipientsSample', 'createdAt', 'createdBy'])
        && ('title' in data) && (data.title is string) && (data.title.size() > 0) && (data.title.size() <= 120)
        && (!('body' in data) || (data.body is string && data.body.size() <= 800))
        && (!('url' in data) || (data.url is string && data.url.size() <= 500))
        && (!('recipientsCount' in data) || (data.recipientsCount is int && data.recipientsCount >= 0))
        && (!('broadcast' in data) || (data.broadcast is bool))
        && (!('recipientsSample' in data) || (data.recipientsSample is list && data.recipientsSample.size() <= 50))
        && (!('createdBy' in data) || (data.createdBy is string && data.createdBy.size() > 0 && data.createdBy.size() <= 128))
        && (!('createdAt' in data) || (data.createdAt is timestamp));
    }
  }
}
