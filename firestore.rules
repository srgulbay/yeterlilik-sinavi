rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid}/topics/{topicId} {
      allow read, write: if request.auth != null && request.auth.uid == uid
        && isValid(request.resource.data);
    }

    match /users/{uid}/favorites/{favId} {
      allow read, write: if request.auth != null && request.auth.uid == uid
        && isFavoriteValid(request.resource.data);
    }

    match /users/{uid}/prefs/{prefId} {
      allow read, write: if request.auth != null && request.auth.uid == uid
        && isPrefsValid(request.resource.data);
    }

    function isValid(data) {
      return (data.favorite is bool || !('favorite' in data))
        && (data.readLevel is int || !('readLevel' in data))
        && (!('readLevel' in data) || (data.readLevel >= 0 && data.readLevel <= 5));
    }

    function isFavoriteValid(data) {
      return (data.type is string || !('type' in data))
        && (data.itemId is string || !('itemId' in data))
        && (data.favorite is bool || !('favorite' in data));
    }

    function isPrefsValid(data) {
      return data.keys().hasOnly(['theme', 'topicsListLayout', 'updatedAt'])
        && (!('theme' in data) || (data.theme is string && (data.theme == 'light' || data.theme == 'dark')))
        && (!('topicsListLayout' in data) || (data.topicsListLayout is string && (data.topicsListLayout == 'cards' || data.topicsListLayout == 'compact')))
        && (!('updatedAt' in data) || (data.updatedAt is timestamp));
    }
  }
}
